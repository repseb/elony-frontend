<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="stylesheet.css">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>

    <!-- DBD001: Tabel Kate en Jacobine == Overzichtstabel meetpunt per maand -->
    <script>
      // Bypass een actie om en de tabel te laden
      window.onload = function() {
        tabeltonen(); 
      };

      function tabeltonen(){
        fetch("http://127.0.0.1:5000/tabel_tesla_beursdata")
        .then(r => r.json())
        .then(d => tabelnaarHTML(d))
        .catch(err => console.error("Error ophalen data:", err)); // Error handling
      };

      function tabelnaarHTML(d){
        // Extraheer de data
        data = d.parsed

        // Converteer timestamps naar leesbare data
        const dates = data.map(entry => new Date(entry.Date).toLocaleDateString());
        const tslaValues = data.map(entry => entry.TSLA);

        // Maak tabeldata voor Plotly
        const tabelData = {
          type: 'table',
          header: {
              values: ["Datum", "TESLA beurswaarde"],  // Column headers
              align: "center"
          },
          cells: {
              values: [dates, tslaValues],
              align: "center"
          }
        };

        // Plot de tabel met Plotly
        Plotly.newPlot('tabelbeursdata', [tabelData])
          .then(() => console.log("Tabel succesvol gerendered"))
          .catch(err => console.error("Error in het renderen van Plotly tabel:", err));
        
      }
    </script>

    <!-- DBD002: grafiek Kate en Jacobine == Grafiek met matplotlib -->
    <script>
        function visualisatie_matplotlib_grafiek() {
            fetch("http://127.0.0.1:5000/lijngrafiek_beursdata_matplotlib") // fetch link 
                .then(response => response.blob())  // Uitleg blob zie google doc met notities
                .then(blob => {
                    let imgURL = URL.createObjectURL(blob);
                    let imgElement = document.createElement("img");
                    imgElement.src = imgURL;
                    imgElement.alt = "Lijngrafiek Beursdata";
                    document.getElementById("lijngrafiek_beursdata").appendChild(imgElement);
                })
        }
        visualisatie_matplotlib_grafiek();
    </script>
    
    <!-- Tabel Niek == Interactieve tabel -->
    <script>
        function load_date_range(){
            start_date = document.getElementById('input_start_date').value
            end_date = document.getElementById('input_end_date').value
            url = "http://127.0.0.1:5000/tabel_tesla_beursdata/"+ start_date + "/" + end_date
            fetch(url)
            .then(r => r.json())
            .then(r => populate_plotly(r))
        }
    </script>
    <script>
        function populate_plotly(input){

            const dates = Object.values(input.Date).map(timestamp => new Date(timestamp).toISOString().split('T')[0]);
            const tslaValues = Object.values(input.TSLA).map(value => value.toFixed(2)); 

            const tableData = [{
                type: 'table',
                header: {
                    values: [["<b>Date</b>"], ["<b>TSLA</b>"]],
                    align: "center",
                    line: { width: 1, color: 'black' },
                    fill: { color: 'grey' },
                    font: { family: "Arial", size: 12, color: "white" }
                },
                cells: {
                    values: [dates, tslaValues],
                    align: "center",
                    line: { color: "black", width: 1 },
                    fill: { color: ['white', 'lightgrey'] },
                    font: { family: "Arial", size: 11, color: ["black"] }
                }
                }];

                const lineChartData = [{
                    x: dates,
                    y: tslaValues,
                    
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: 'blue' },
                    marker: { color: 'red' },
                    name: 'TSLA'
                }];
                

                Plotly.newPlot('tesla_chart', lineChartData, {
                    title: 'TSLA datum tegen prijs',
                    xaxis: { title: 'Date' },
                    yaxis: { title: 'Price (TSLA)' }
                })
                .then(()=> console.log("plotted succesfully"))
                .catch(e => console.log("plotting went wrong with:"+ e))

                Plotly.newPlot('tesla_table', tableData,{
                    title : 'TSLA datum en prijs',
                })
                .then(()=> console.log("plotted succesfully"))
                .catch(e => console.log("plotting went wrong with:"+ e))
        }       

    </script>
    
</head>

</head>
<body>
    <main>
        <h1>Welkom bij Elony!</h1> 
        <br>
        <p> 
            Op deze pagina vind u informatie over de beursdata van Tesla. 
            Bovenaan de pagina vind u een overzichtstabel met een meetpunt 
            per maand van januari 2015 tot en met december. Daaronder vind 
            u een lijngrafiek van deze data.
        </p>
        <div id="tabelbeursdata"></div>
        <div id="lijngrafiek_beursdata"></div>
    <div>
        <br>
        <p> 
            Onder de overzichtstabel en overzichtsgrafiek vind u een interactieve tabel.
            In deze tabel kunt u zelf selecteren voor welke periode u de beursdata 
            wilt bekijken.
        </p>
        <div id="tesla_table"></div>
        <div id="tesla_chart"></div>
        <div>
            <a>Start datum</a>
            <input id="input_start_date" type="date">
        </div>
        <div>
            <a>Eind datum</a>
            <input id="input_end_date" type="date">
        </div>
        <div>
            <button  onclick="load_date_range()">Update tabel</button>
        </div>
    </div>
</body>